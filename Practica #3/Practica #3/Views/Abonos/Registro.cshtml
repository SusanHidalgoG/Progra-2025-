@model IEnumerable<Practica__3.Models.CompraPend>
@{
    ViewData["Title"] = "Registro de Abono";
    var error = ViewBag.Error as string;
    var selId = ViewBag.SelId?.ToString();
    var montoPrev = ViewBag.Monto?.ToString();
}
<div class="container mt-4">
    <h2 class="mb-4"><i class="fas fa-cash-register me-2"></i> Registro de Abono</h2>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger">@error</div>
    }

    <form asp-action="Registro" method="post" id="frmAbono" class="card p-4 shadow-sm">
        <div class="mb-3">
            <label class="form-label fw-bold">Compra</label>
            <select class="form-select" name="Id_Compra" id="Id_Compra" required>
                <option value="">-- Seleccione --</option>
                @foreach (var c in Model)
                {
                    <option value="@c.Id_Compra" selected="@(selId == c.Id_Compra.ToString())">
                        @($"{c.Id_Compra} - {c.Descripcion}")
                    </option>
                }
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Saldo anterior</label>
            <input class="form-control" type="number" step="0.01" id="SaldoAnterior" readonly />
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Abono</label>
            <input class="form-control" type="number" step="0.01" name="Monto" id="Monto" value="@(montoPrev ?? "")" required />
            <div class="form-text">El abono no puede superar el saldo anterior.</div>
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Abonar
        </button>
    </form>
</div>

@section Scripts {
    <script>
        $('#Id_Compra').on('change', function(){
          const id = $(this).val();
          $('#SaldoAnterior').val('');
          if(!id) return;
          $.get('/Abonos/ObtenerSaldo', { id })
            .done(r => $('#SaldoAnterior').val(r.saldo))
            .fail(() => alert('No se pudo obtener el saldo.'));
        });


        if ($('#Id_Compra').val()) { $('#Id_Compra').trigger('change'); }

        $('#frmAbono').on('submit', function(e){
          const s = parseFloat($('#SaldoAnterior').val() || '0');
          const a = parseFloat($('#Monto').val() || '0');
          if (s <= 0 || isNaN(s)) { e.preventDefault(); alert('Seleccione una compra con saldo.'); }
          else if (a <= 0) { e.preventDefault(); alert('El abono debe ser mayor a cero.'); }
          else if (a > s) { e.preventDefault(); alert('El abono no puede ser mayor al saldo.'); }
        });
    </script>
}
